# .github/workflows/npm-audit.yml
name: NPM Audit

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  audit:
    name: Run npm audit
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repo
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üõ°Ô∏è Run npm audit and output results
        run: |
          echo "Running audit..."
          npm audit --audit-level=moderate || true
        continue-on-error: true

      - name: ‚ùå Fail if vulnerabilities found
        run: |
          RESULT=$(npm audit --audit-level=moderate --json)
          COUNT=$(echo "$RESULT" | jq '.metadata.vulnerabilities | to_entries | map(select(.value > 0)) | length')
          echo "$RESULT" | jq
          if [ "$COUNT" -gt 0 ]; then
            echo "‚ùå Found $COUNT vulnerabilities"
            exit 1
          fi
